import{c as p,a,o as c,d as rt,i as _,r as Y,h as it,n as dt,p as C,e as P,N as ut,b as f,v as w,E as G,F as V,q as E,B as J,s as S,H as mt,t as y,y as pt,w as ct,f as bt}from"./index-BFEQWBay.js";import{E as _t,a as ft}from"./jspdf.plugin.autotable-BceNMa6r.js";import{_ as K}from"./Modal.vue_vue_type_script_setup_true_lang-DrVpGJl3.js";import{r as yt}from"./PlusIcon-NzFvHLfC.js";import{a as vt,s as ht,f as B,p as xt}from"./parseISO-Crjmnvoz.js";import{e as gt}from"./endOfDay-DftzdkkI.js";import{a as wt,s as Q,e as X}from"./subMonths-DgZhT8O2.js";import{e as Dt}from"./endOfWeek-BU3M2hNK.js";function kt(Z,v){return c(),p("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"})])}const Ct={class:"space-y-6"},St={class:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4"},Mt={class:"flex gap-2"},At={class:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-500/30 rounded-lg p-4"},It={class:"flex"},Ft={class:"card p-4"},Ot={class:"mb-4"},$t={class:"flex flex-wrap gap-2"},Tt={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},Pt=["value"],Vt={class:"card overflow-hidden"},Et={class:"overflow-x-auto"},Bt={class:"min-w-full inline-block align-middle"},Nt={class:"overflow-hidden"},Ut={class:"min-w-full divide-y divide-slate-200 dark:divide-slate-800"},qt={class:"divide-y divide-slate-200 dark:divide-slate-800"},Wt={class:"table-cell px-6 py-4"},Rt={class:"table-cell px-6 py-4 font-medium"},jt={class:"table-cell px-6 py-4 text-right"},zt={class:"table-cell px-6 py-4 text-right"},Lt={class:"table-cell px-6 py-4 text-right"},Ht={class:"table-cell px-6 py-4 text-right"},Yt=["onClick"],Gt=["value"],Jt={class:"w-full h-[75vh]"},Kt=["src"],Qt={class:"flex justify-end gap-2 mt-4"},Xt=["href","download"],re=rt({__name:"DailyCollections",setup(Z){const{addToast:v}=mt(),I=_([]),D=_([]),N=_([]),U=_(!0),F=_(!1),q=_(null),O=_(!1),k=_(""),l=Y({startDate:"",endDate:"",barberId:""}),o=Y({id:null,collection_date:new Date().toISOString().substring(0,10),barber_id:"",total_amount_manually_entered:null,number_of_appointments:null,notes:""}),W=it(()=>I.value.filter(n=>{const e=new Date(n.collection_date),t=l.startDate?new Date(l.startDate):null,i=l.endDate?new Date(l.endDate):null;return!(t&&e<t||i&&e>i||l.barberId&&n.barber_id!==l.barberId)})),R=n=>B(xt(n),"MMM d, yyyy"),tt=(n,e)=>n===void 0?"N/A":(e-n).toFixed(2),et=(n,e)=>{if(n===void 0)return"";const t=e-n;return t>0?"text-green-500":t<0?"text-red-500":""},j=n=>{q.value=n,n?(o.id=n.id,o.collection_date=n.collection_date,o.barber_id=n.barber_id,o.total_amount_manually_entered=n.total_amount_manually_entered,o.number_of_appointments=n.number_of_appointments||null,o.notes=n.notes||""):(o.id=null,o.collection_date=new Date().toISOString().substring(0,10),o.barber_id="",o.total_amount_manually_entered=null,o.number_of_appointments=null,o.notes=""),F.value=!0},$=()=>{F.value=!1},z=()=>{O.value=!1,k.value=""},at=async()=>{if(o.total_amount_manually_entered==null||o.total_amount_manually_entered<=0){v({type:"error",title:"Invalid Input",message:"Manual Amount must be a positive number."});return}if(o.number_of_appointments==null||o.number_of_appointments<=0){v({type:"error",title:"Invalid Input",message:"Number of Appointments must be a positive number."});return}const n={collection_date:o.collection_date,barber_id:parseInt(o.barber_id),total_amount_manually_entered:o.total_amount_manually_entered,number_of_appointments:o.number_of_appointments,notes:o.notes};let e;o.id?{error:e}=await S.from("daily_collections").update(n).eq("id",parseInt(o.id)):{error:e}=await S.from("daily_collections").insert(n),e?v({type:"error",title:"Error",message:e.message}):(v({type:"success",title:"Success",message:"Collection saved!"}),$(),L())},L=async()=>{U.value=!0;const{data:n,error:e}=await S.from("daily_collections").select("*, barber:barbers(*)").order("collection_date",{ascending:!1});if(e)v({type:"error",title:"Error",message:e.message}),I.value=[];else{const t=(n||[]).map(i=>{const s=i,x=s.collection_date,g=N.value.filter(h=>parseInt(h.barber_id)===s.barber_id&&h.start_time.startsWith(x)&&h.status==="completed").reduce((h,r)=>h+(r.total_amount||0),0);return{id:s.id.toString(),barber_id:s.barber_id.toString(),collection_date:s.collection_date,total_amount_manually_entered:s.total_amount_manually_entered,number_of_appointments:s.number_of_appointments,notes:s.notes,created_at:s.created_at,updated_at:s.updated_at,barber:s.barber?{id:s.barber.id.toString(),user_id:s.barber.user_id,name:s.barber.name,phone_number_work:s.barber.phone_number_work,phone_number_home:s.barber.phone_number_home,email:s.barber.email,home_address:s.barber.home_address,is_active:s.barber.is_active,created_at:s.barber.created_at,updated_at:s.barber.updated_at,visa_number:s.barber.visa_number,visa_expiry_date:s.barber.visa_expiry_date,passport_number:s.barber.passport_number,passport_expiry_date:s.barber.passport_expiry_date}:void 0,total_amount_calculated:g}});I.value=t}U.value=!1},nt=async()=>{const{data:n,error:e}=await S.from("barbers").select("*");!e&&n&&(D.value=n.map(t=>({id:t.id.toString(),user_id:t.user_id,name:t.name,phone_number_work:t.phone_number_work,phone_number_home:t.phone_number_home,email:t.email,home_address:t.home_address,is_active:t.is_active,created_at:t.created_at,updated_at:t.updated_at,visa_number:t.visa_number,visa_expiry_date:t.visa_expiry_date,passport_number:t.passport_number,passport_expiry_date:t.passport_expiry_date})))},st=async()=>{const{data:n,error:e}=await S.from("appointments").select("*");!e&&n&&(N.value=n.map(t=>({id:t.id.toString(),client_id:t.client_id.toString(),barber_id:t.barber_id.toString(),start_time:t.start_time,end_time:t.end_time,status:t.status,total_amount:t.total_amount,notes:t.notes,created_at:t.created_at,updated_at:t.updated_at})))},M=n=>{const e=new Date;let t,i;switch(n){case"today":t=ht(e),i=gt(e);break;case"thisWeek":t=vt(e,{weekStartsOn:1}),i=Dt(e,{weekStartsOn:1});break;case"thisMonth":t=Q(e),i=X(e);break;case"previousMonth":const s=wt(e);t=Q(s),i=X(s);break;default:return}l.startDate=B(t,"yyyy-MM-dd"),l.endDate=B(i,"yyyy-MM-dd")},ot=()=>{l.startDate="",l.endDate=""},lt=()=>{const n=new _t({orientation:"landscape"}),e=W.value;if(e.length===0){v({type:"error",title:"No Data",message:"There is no data to generate a PDF for the selected filters."});return}let t=[];if(l.barberId){const r=D.value.find(m=>m.id===l.barberId);r&&(t=[r])}else{const r=[...new Set(e.map(m=>m.barber_id))];t=D.value.filter(m=>r.includes(m.id))}const i=[...new Set(e.map(r=>r.collection_date))].sort(),s=new Map;i.forEach(r=>{const m=new Map;t.forEach(b=>{const d=e.find(u=>u.collection_date===r&&u.barber_id===b.id);m.set(b.id,{appointments:(d==null?void 0:d.number_of_appointments)??0,collection:(d==null?void 0:d.total_amount_manually_entered)??0})}),s.set(r,m)});const x=[[{content:"Date",rowSpan:2,styles:{halign:"center",valign:"middle"}},...t.map(r=>({content:r.name,colSpan:2,styles:{halign:"center"}})),{content:"Total",rowSpan:2,styles:{halign:"center",valign:"middle"}}],t.flatMap(()=>["No:Appoint","Collection"])],A=i.map(r=>{const m=[R(r)];let b=0;return t.forEach(d=>{var H;const u=(H=s.get(r))==null?void 0:H.get(d.id);m.push((u==null?void 0:u.appointments)??"-"),m.push((u==null?void 0:u.collection.toFixed(2))??"0.00"),b+=(u==null?void 0:u.collection)??0}),m.push(b.toFixed(2)),m}),g=[{content:"Total",styles:{fontStyle:"bold"}}];let T=0;t.forEach(r=>{const m=e.filter(d=>d.barber_id===r.id).reduce((d,u)=>d+(u.number_of_appointments||0),0),b=e.filter(d=>d.barber_id===r.id).reduce((d,u)=>d+(u.total_amount_manually_entered||0),0);T+=b,g.push({content:m.toString(),styles:{fontStyle:"bold"}}),g.push({content:b.toFixed(2),styles:{fontStyle:"bold"}})}),g.push({content:T.toFixed(2),styles:{fontStyle:"bold",halign:"center"}}),A.push(g),n.setFontSize(18),n.text("VASA SALOON - Daily Collections Report",14,22);const h=`Period: ${l.startDate||"Start"} to ${l.endDate||"End"}`;n.setFontSize(11),n.text(h,14,30),ft(n,{head:x,body:A,startY:38,theme:"grid",headStyles:{fillColor:[243,244,246],textColor:17,fontStyle:"bold",halign:"center"},styles:{halign:"center"},columnStyles:{0:{halign:"left"}}}),k.value=n.output("datauristring"),O.value=!0};return dt(async()=>{await nt(),await st(),await L()}),(n,e)=>(c(),p("div",Ct,[a("div",St,[e[16]||(e[16]=a("h1",{class:"text-2xl font-bold text-slate-900 dark:text-slate-100"},"Daily Collections",-1)),a("div",Mt,[a("button",{onClick:lt,class:"btn btn-outline"},[C(P(kt),{class:"w-4 h-4 md:mr-2"}),e[14]||(e[14]=a("span",{class:"hidden md:inline"},"Download PDF",-1))]),a("button",{onClick:e[0]||(e[0]=t=>j(null)),class:"btn btn-primary"},[C(P(yt),{class:"w-4 h-4 md:mr-2"}),e[15]||(e[15]=a("span",{class:"hidden md:inline"},"Add Collection",-1))])])]),a("div",At,[a("div",It,[C(P(ut),{class:"h-5 w-5 text-blue-400 dark:text-blue-300 mt-0.5"}),e[17]||(e[17]=a("div",{class:"ml-3"},[a("h3",{class:"text-sm font-medium text-blue-800 dark:text-blue-200"},"Manual Collection Entry"),a("div",{class:"mt-2 text-sm text-blue-700 dark:text-blue-300"},[a("p",null,"This section allows you to manually record daily collection totals as a safety net or transitional tool. The primary revenue tracking is automatically calculated from completed appointments.")])],-1))])]),a("div",Ft,[a("div",Ot,[a("div",$t,[a("button",{onClick:e[1]||(e[1]=t=>M("today")),class:"btn btn-outline btn-sm"},"Today"),a("button",{onClick:e[2]||(e[2]=t=>M("thisWeek")),class:"btn btn-outline btn-sm"},"This Week"),a("button",{onClick:e[3]||(e[3]=t=>M("thisMonth")),class:"btn btn-outline btn-sm"},"This Month"),a("button",{onClick:e[4]||(e[4]=t=>M("previousMonth")),class:"btn btn-outline btn-sm"},"Previous Month"),a("button",{onClick:e[5]||(e[5]=t=>ot()),class:"btn btn-ghost btn-sm"},"Clear")])]),a("div",Tt,[f(a("input",{"onUpdate:modelValue":e[6]||(e[6]=t=>l.startDate=t),type:"date",class:"input"},null,512),[[w,l.startDate]]),f(a("input",{"onUpdate:modelValue":e[7]||(e[7]=t=>l.endDate=t),type:"date",class:"input"},null,512),[[w,l.endDate]]),f(a("select",{"onUpdate:modelValue":e[8]||(e[8]=t=>l.barberId=t),class:"select"},[e[18]||(e[18]=a("option",{value:""},"All Barbers",-1)),(c(!0),p(V,null,E(D.value,t=>(c(),p("option",{key:t.id,value:t.id},y(t.name),9,Pt))),128))],512),[[G,l.barberId]])])]),a("div",Vt,[a("div",Et,[a("div",Bt,[a("div",Nt,[a("table",Ut,[e[19]||(e[19]=a("thead",null,[a("tr",null,[a("th",{scope:"col",class:"table-header px-6 py-3 text-left"},"Date"),a("th",{scope:"col",class:"table-header px-6 py-3 text-left"},"Barber"),a("th",{scope:"col",class:"table-header px-6 py-3 text-right"},"Appointments"),a("th",{scope:"col",class:"table-header px-6 py-3 text-right"},"Calculated Amount"),a("th",{scope:"col",class:"table-header px-6 py-3 text-right"},"Manual Amount"),a("th",{scope:"col",class:"table-header px-6 py-3 text-right"},"Difference"),a("th",{scope:"col",class:"table-header px-6 py-3 text-right"},"Actions")])],-1)),a("tbody",qt,[(c(!0),p(V,null,E(W.value,t=>{var i,s,x;return c(),p("tr",{key:t.id,class:"table-row"},[a("td",Wt,y(R(t.collection_date)),1),a("td",Rt,y(((i=t.barber)==null?void 0:i.name)||"N/A"),1),a("td",jt,y(t.number_of_appointments??0),1),a("td",zt,"$"+y(((s=t.total_amount_calculated)==null?void 0:s.toFixed(2))??"0.00"),1),a("td",Lt,"$"+y(((x=t.total_amount_manually_entered)==null?void 0:x.toFixed(2))??"0.00"),1),a("td",{class:pt(["table-cell px-6 py-4 text-right",et(t.total_amount_calculated,t.total_amount_manually_entered)])}," $"+y(tt(t.total_amount_calculated,t.total_amount_manually_entered)),3),a("td",Ht,[a("button",{onClick:A=>j(t),class:"btn btn-ghost"},"Edit",8,Yt)])])}),128))])])])])])]),C(K,{"is-open":F.value,title:q.value?"Edit Collection":"Add Collection",onClose:$},{default:J(()=>[a("form",{onSubmit:ct(at,["prevent"]),class:"space-y-4"},[a("div",null,[e[20]||(e[20]=a("label",{class:"block text-sm font-medium"},"Date",-1)),f(a("input",{"onUpdate:modelValue":e[9]||(e[9]=t=>o.collection_date=t),type:"date",required:"",class:"input"},null,512),[[w,o.collection_date]])]),a("div",null,[e[22]||(e[22]=a("label",{class:"block text-sm font-medium"},"Barber",-1)),f(a("select",{"onUpdate:modelValue":e[10]||(e[10]=t=>o.barber_id=t),required:"",class:"select"},[e[21]||(e[21]=a("option",{value:""},"Select Barber",-1)),(c(!0),p(V,null,E(D.value,t=>(c(),p("option",{key:t.id,value:t.id},y(t.name),9,Gt))),128))],512),[[G,o.barber_id]])]),a("div",null,[e[23]||(e[23]=a("label",{class:"block text-sm font-medium"},"Manual Amount",-1)),f(a("input",{"onUpdate:modelValue":e[11]||(e[11]=t=>o.total_amount_manually_entered=t),type:"number",step:"0.01",required:"",class:"input",placeholder:"eg. 1230.00"},null,512),[[w,o.total_amount_manually_entered,void 0,{number:!0}]])]),a("div",null,[e[24]||(e[24]=a("label",{class:"block text-sm font-medium"},"Number of Appointments",-1)),f(a("input",{"onUpdate:modelValue":e[12]||(e[12]=t=>o.number_of_appointments=t),type:"number",step:"1",required:"",class:"input",placeholder:"eg. 10.."},null,512),[[w,o.number_of_appointments,void 0,{number:!0}]])]),a("div",null,[e[25]||(e[25]=a("label",{class:"block text-sm font-medium"},"Notes",-1)),f(a("textarea",{"onUpdate:modelValue":e[13]||(e[13]=t=>o.notes=t),class:"textarea"},null,512),[[w,o.notes]])]),a("div",{class:"flex justify-end gap-2"},[a("button",{type:"button",onClick:$,class:"btn btn-outline"},"Cancel"),e[26]||(e[26]=a("button",{type:"submit",class:"btn btn-primary"},"Save",-1))])],32)]),_:1},8,["is-open","title"]),C(K,{"is-open":O.value,title:"PDF Preview",onClose:z,size:"xl"},{default:J(()=>[a("div",Jt,[k.value?(c(),p("iframe",{key:0,src:k.value,class:"w-full h-full border-0",title:"PDF Preview"},null,8,Kt)):bt("",!0)]),a("div",Qt,[a("button",{type:"button",onClick:z,class:"btn btn-outline"},"Close"),a("a",{href:k.value,download:`vasa-saloon-collections-${new Date().toISOString().slice(0,10)}.pdf`,class:"btn btn-primary"},"Download PDF",8,Xt)])]),_:1},8,["is-open"])]))}});export{re as default};
